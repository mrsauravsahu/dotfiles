#! /usr/bin/env zsh

mode="$1"
# shift
dirs=("$HOME/.mrsauravsahu/dotfiles" "$HOME/.config/nvim" "$HOME/.config/wezterm")
exit_code=0

case "$mode" in
  push)
    echo "Starting git push operation on provided directories..."
    for d in "${dirs[@]}"; do
      if [ -d "$d" ]; then
        echo "Processing '$d'..."
        prev_dir=$(pwd)

        # Check dir
        if cd "$d"; then

          # Check if it is a git directory
          if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            if [ $? -eq 0 ]; then

              # Check if local commits have been pushed to remote
              local commits=$(git rev-list --count HEAD~..HEAD)
              if [ -n "$commits" ]; then
                echo "ðŸŸ¡ Local commits haven't been pushed in '$d'"
              fi

              # Check if local changes exist. And count number of files
              local local_file_changes=$(git diff HEAD --name-only | wc -l | xarg)
              if [ -n "$local_file_changes" ]; then
                echo "ðŸŸ¡ Local file changes in '$d' files."
              fi
            fi
          else
            echo "Directory '$d' is not a git repository"
          fi
          cd "$prev_dir" >/dev/null 2>&1 || true
        else
          echo "Failed to cd into '$d'"
        fi
      else
        echo "Directory '$d' does not exist!"
      fi
    done
    ;;
  status)
    echo "Displaying git status for provided directories..."
    for d in "${dirs[@]}"; do
      if [ -d "$d" ]; then
        echo "â€£ $d"
        prev_dir=$(pwd)
        if cd "$d"; then
          if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            if [ -n "$(git status --porcelain)" ]; then
              count=$(git status --porcelain | wc -l)
              echo -e "\t ðŸŸ¡ local changes need to be committed: $count file(s)"
            else
              echo -e "\t âœ… clean working tree"
            fi
          else
            echo "\t Not a git repository"
          fi
          cd "$prev_dir" >/dev/null 2>&1 || true
        else
          echo "Failed to cd into '$d'"
        fi
      else
        echo "Directory '$d' does not exist!"
      fi
    done
    ;;
  pull)
    echo "Pulling latest changes for provided directories..."
    for d in "${dirs[@]}"; do
      if [ -d "$d" ]; then
        echo "Processing '$d'..."
        prev_dir=$(pwd)
        if cd "$d"; then
          if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            if git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null; then
              if git pull; then
                echo "âœ… Pulled latest changes in '$d'"
              else
                echo "âŒ Pull failed in '$d'"
              fi
            else
              echo "ðŸŸ¡ Changes exist locally in '$d'; cannot pull"
            fi
          else
            echo "Directory '$d' is not a git repository"
          fi
          cd "$prev_dir" >/dev/null 2>&1 || true
        else
          echo "Failed to cd into '$d'"
        fi
      else
        echo "Directory '$d' does not exist!"
      fi
    done
    ;;
  *)
    echo "Invalid mode: $mode"
    echo "Usage: process_git_dirs <push|status|pull> <dir1> <dir2> â€¦"
    ;;
esac

exit $exit_code

